<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOLIDAY ToDo (æœ€çµ‚ä¿®æ­£ç‰ˆãƒ»v6)</title>
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«CSSã‚’ç›´æ¥è¨˜è¿° -->
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            padding-bottom: 80px;
            padding-top: 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .task-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 1rem;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .calendar-dot {
            width: 6px;
            height: 6px;
            background-color: #ef4444;
            border-radius: 50%;
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
        }
        .is-today {
            background-color: #e0f2fe;
            color: #0ea5e9;
            font-weight: bold;
        }
        .nav-button.active {
            color: #0284c7;
        }
        .modal-enter-active { animation: fadeIn 0.2s ease-out; }
        .modal-leave-active { animation: fadeOut 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }

        /* --- ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #guardian-banner-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
            padding: 10px;
            background-color: #f9fafb;
            max-width: 100%;
        }
        .guardian-banner {
            animation: pulse-bg 2s infinite;
            padding: 0.75rem;
        }
        .guardian-text-flash {
            color: #facc15;
            font-size: 1.125rem;
            animation: flash-yellow 1.5s infinite;
        }
        @keyframes flash-yellow {
            0%, 100% { color: #facc15; opacity: 1; transform: scale(1.05); }
            50% { color: #fde047; opacity: 0.8; transform: scale(1); }
        }
        .guardian-task {
            border: 2px solid #f87171;
            box-shadow: 0 0 15px rgba(248, 113, 113, 0.5);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: #f87171; }
            50% { border-color: #dc2626; }
        }
        @keyframes pulse-bg {
            0%, 100% { background-color: #ef4444; }
            50% { background-color: #dc2626; }
        }
        
        /* --- ã‚¢ã‚¤ã‚¼ãƒ³ãƒãƒ¯ãƒ¼ãƒãƒˆãƒªã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .matrix-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1rem;
            height: 60vh;
        }
        .matrix-quadrant {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s;
        }
        .matrix-quadrant.drag-over {
            background-color: #e0f2fe;
            border-style: solid;
        }
        .matrix-quadrant h3 {
            font-size: 0.875rem;
            font-weight: bold;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .matrix-tasks {
            overflow-y: auto;
            flex-grow: 1;
            min-height: 50px;
        }
        .matrix-task {
            background-color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            cursor: grab;
        }
        .matrix-task.dragging {
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <div id="guardian-banner-container"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div id="app-container" class="max-w-2xl mx-auto p-4"></div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center transform"></div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <footer class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 shadow-t-sm">
        <nav class="max-w-2xl mx-auto flex justify-around">
            <button data-view="list" class="nav-button active flex-1 py-3 text-center"><i class="fas fa-list-ul fa-lg"></i><span class="block text-xs font-medium">ãƒ¡ã‚¤ãƒ³</span></button>
            <button data-view="matrix" class="nav-button flex-1 py-3 text-center text-gray-500"><i class="fas fa-th-large fa-lg"></i><span class="block text-xs font-medium">ãƒãƒˆãƒªã‚¯ã‚¹</span></button>
            <button data-view="create" class="nav-button flex-1 py-3 text-center text-gray-500"><i class="fas fa-plus-square fa-lg"></i><span class="block text-xs font-medium">æ–°è¦ä½œæˆ</span></button>
            <button data-view="account" class="nav-button flex-1 py-3 text-center text-gray-500"><i class="fas fa-user-circle fa-lg"></i><span class="block text-xs font-medium">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</span></button>
        </nav>
    </footer>

    <script type="module">
        // --- çŠ¶æ…‹ç®¡ç† ---
        const state = {
            todos: [],
            currentFilter: 'all',
            currentDate: new Date(),
            consecutiveOverdue: 0,
        };

        // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é›† (å¤‰æ›´ãªã—) ---
        const messages = {
            reward: ["ãŠç–²ã‚Œæ§˜ï¼ã“ã‚Œã§å¿ƒç½®ããªããŠã‚„ã¤ãŒé£Ÿã¹ã‚‰ã‚Œã¾ã™ã­ï¼", "ã‚¿ã‚¹ã‚¯å®Œäº†ï¼ã‚ãªãŸã¯å¤©æ‰ã§ã™ã‹ï¼Ÿã„ã„ãˆã€åŠªåŠ›ã®å¤©æ‰ã§ã™ã€‚", "ç´ æ™´ã‚‰ã—ã„ï¼ãã®èª¿å­ã§æ¬¡ã®ã”è¤’ç¾ã‚‚ã‚²ãƒƒãƒˆã ï¼", "å®Œäº†ï¼ã¾ã‚‹ã§ã‚²ãƒ¼ãƒ ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ãŸæ°—åˆ†ï¼", "ãŠè¦‹äº‹ï¼è„³å†…ã«ãƒ‰ãƒ¼ãƒ‘ãƒŸãƒ³ãŒæº¢ã‚Œå‡ºã¦ã„ã‚‹ã¯ãšï¼", "ä¸€ã¤å®Œäº†ã€ä¸€ã¤æˆé•·ã€‚æœªæ¥ã®ã‚ãªãŸã«æ„Ÿè¬ã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚", "å®Œç’§ã§ã™ï¼ä»Šæ—¥ã¯æ•ã‚’é«˜ãã—ã¦çœ ã‚Œã¾ã™ã­ã€‚", "ä»»å‹™å®Œäº†ï¼è‡ªåˆ†ã‚’è¤’ã‚ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚ãƒ“ãƒ¼ãƒ«ãŒã†ã¾ã„ï¼", "ãƒŠã‚¤ã‚¹ï¼ToDoãƒªã‚¹ãƒˆãŒè»½ããªã‚‹ã¨å¿ƒã‚‚è»½ããªã‚‹ï¼", "ã‚„ã‚Šã¾ã—ãŸã­ï¼ãã®é”æˆæ„Ÿã€å™›ã—ã‚ã¦ãã ã•ã„ã€‚", "å®Œäº†ãŠã‚ã§ã¨ã†ï¼ã‚ãªãŸã¯è‡ªåˆ†ã®äººç”Ÿã®ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã§ã™ã€‚", "ã‚ãªãŸã®é›†ä¸­åŠ›ã«ä¹¾æ¯ï¼", "ã“ã®ã‚¿ã‚¹ã‚¯ã€ã‚‚ã¯ã‚„ã‚ãªãŸã®ä¼èª¬ã®ä¸€éƒ¨ã§ã™ã€‚", "ã‚„ã‚‹ã¹ãã“ã¨ãŒç‰‡ä»˜ãã¨ã€ä¸–ç•ŒãŒè¼ã„ã¦è¦‹ãˆã¾ã›ã‚“ã‹ï¼Ÿ", "OKã€Googleã€‚ä»Šæ—¥ã®ç§ã€æœ€é«˜ã€‚", "ä¸€æ­©ä¸€æ­©ãŒã€å¤§ããªæœªæ¥ã¸ç¹‹ãŒã£ã¦ã„ã¾ã™ã€‚", "å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã€ãã®ç¬é–“ãŒãŸã¾ã‚‰ãªã„ï¼", "ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸï¼ã”è¤’ç¾ã«å¥½ããªæ›²ã§ã‚‚è´ãã¾ã™ã‹ï¼Ÿ", "ã“ã‚Œã§å®‰å¿ƒã—ã¦æ¬¡ã®æ²¼ã«ãƒãƒã‚Œã¾ã™ã­ã€‚", "ã•ã™ãŒï¼ãƒ‡ã‚­ã‚‹äººã¯é•ã„ã¾ã™ã­ï¼"],
            gentle: ["ãŠç–²ã‚Œæ§˜ã§ã™ã€‚æœŸé™ã¯éãã¡ã‚ƒã£ãŸã‘ã©ã€å®Œäº†ã§ãã¦ãˆã‚‰ã„ï¼", "å¤§ä¸ˆå¤«ã€èª°ã«ã§ã‚‚ãã†ã„ã†æ—¥ã¯ã‚ã‚Šã¾ã™ã€‚ã¾ãšã¯ä¸€ã¤å®Œäº†ï¼", "å®Œäº†ãŠã‚ã§ã¨ã†ï¼æ¬¡ã¯ã‚‚ã†å°‘ã—ã ã‘æ—©ã‚ã«ãƒˆãƒ©ã‚¤ã—ã¦ã¿ã¾ã—ã‚‡ã†ã‹ã€‚", "æ°—ã«ã—ãªã„ã§ï¼çµ‚ã‚ã‚‰ã›ãŸã“ã¨ãŒä¸€ç•ªå¤§äº‹ã§ã™ã€‚", "ã‚»ãƒ¼ãƒ•ï¼â€¦ã¨ã¯è¨€ãˆãªã„ã‘ã©ã€ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸï¼", "æœŸé™ã¯ã‚ãã¾ã§ç›®å®‰ã€‚ã‚ãªãŸã®ãƒšãƒ¼ã‚¹ã§å¤§ä¸ˆå¤«ã§ã™ã‚ˆã€‚", "ä¸€ã¤ã‚¯ãƒªã‚¢ï¼é…ã‚Œã¦ã‚‚ã€ã‚„ã‚‰ãªã„ã‚ˆã‚Šãšã£ã¨ã„ã„ã€‚", "ãƒ‰ãƒ³ãƒã‚¤ï¼ã“ã®çµŒé¨“ã‚’æ¬¡ã«æ´»ã‹ã—ã¾ã—ã‚‡ã†ã€‚", "ç„¦ã‚‰ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚ãªãŸã®é ‘å¼µã‚Šã€ã¡ã‚ƒã‚“ã¨è¦‹ã¦ã¾ã™ã‚ˆã€‚", "é–“ã«åˆã‚ãªã‹ã£ãŸã‘ã©ã€æœ€å¾Œã¾ã§ã‚„ã‚Šé‚ã’ãŸã‚ãªãŸã‚’å°Šæ•¬ã—ã¾ã™ã€‚"],
            strict: ["ã¾ãŸæœŸé™éãã¦ã¾ã™ã‚ˆã€‚ãã‚ãã‚æœ¬æ°—å‡ºã—ã¾ã›ã‚“ã‹ï¼Ÿ", "ï¼“å›ç›®ã§ã™ã­ã€‚ã“ã®ã‚¿ã‚¹ã‚¯ã€æœ¬å½“ã«ã‚„ã‚‹æ°—ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "ã€Œå¾Œã§ã‚„ã‚ã†ã€ã¯ã€Œã‚„ã‚‰ãªã„ã€ã®ä»²é–“ã§ã™ã€‚è‡ªè¦šã—ã¦ãã ã•ã„ã€‚", "è­¦å‘Šã§ã™ã€‚è¨ˆç”»æ€§ã¨ã„ã†è¨€è‘‰ã€è¾æ›¸ã§å¼•ã„ã¦ã¿ã¦ã¯ï¼Ÿ", "ã‚ãªãŸã®ã€Œç· ã‚åˆ‡ã‚Šã€ã¯ã€ãŸã ã®ã€Œå¸Œæœ›æ—¥ã€ã§ã™ã‹ï¼Ÿ", "ã“ã®ã¾ã¾ã§ã¯ã€ãŸã ã®ã€Œã‚„ã‚‹ã‚„ã‚‹è©æ¬ºã€ã§ã™ã‚ˆã€‚", "æœªæ¥ã®è‡ªåˆ†ã«è¬ã‚Šã¾ã—ã‚‡ã†ã€‚ä»Šã®ã‚ãªãŸã®ã›ã„ã§è‹¦åŠ´ã™ã‚‹ã®ã§ã™ã‹ã‚‰ã€‚", "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€è¦‹ã¦ã¾ã™ã‹ï¼Ÿæ™‚è¨ˆã€å‹•ã„ã¦ã¾ã™ã‹ï¼Ÿ", "ã†ãƒ¼ã‚“ã€ã“ã®èª¿å­ã ã¨ä¿¡é ¼ã‚’å¤±ã„ã¾ã™ã‚ˆã€‚ã¾ãšã¯è‡ªåˆ†ã‹ã‚‰ã®ã€‚", "å³ã—ã„ã“ã¨ã‚’è¨€ã„ã¾ã™ãŒã€ã“ã‚ŒãŒç¾å®Ÿã§ã™ã€‚æ¬¡ã¯ã‚ã‚Šã¾ã›ã‚“ã‚ˆã€‚"]
        };

        // --- HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ---
        const templates = {
            list: `
                <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">HOLIDAY ToDo</h1>
                <div class="flex justify-center gap-2 mb-4">
                    <button id="morning-briefing-btn" class="bg-sky-100 text-sky-700 text-sm font-semibold px-4 py-2 rounded-full hover:bg-sky-200 transition-colors"><i class="fas fa-sun mr-2"></i>ä»Šæ—¥ã®ç¢ºèª</button>
                    <button id="tomorrow-briefing-btn" class="bg-indigo-100 text-indigo-700 text-sm font-semibold px-4 py-2 rounded-full hover:bg-indigo-200 transition-colors"><i class="fas fa-moon mr-2"></i>æ˜æ—¥ã®æº–å‚™</button>
                </div>
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex -mb-px space-x-6" id="todo-tabs">
                        <button data-filter="all" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-sky-600 border-sky-500">å…¨ã¦</button>
                        <button data-filter="today" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">ä»Šæ—¥</button>
                        <button data-filter="tomorrow" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">æ˜æ—¥</button>
                        <button data-filter="week" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">1é€±é–“</button>
                    </nav>
                </div>
                <ul id="todo-list" class="space-y-3"></ul>
                <div id="calendar-container" class="mt-8 bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-left text-gray-600"></i></button>
                        <h2 id="calendar-header" class="text-lg font-semibold"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-chevron-right text-gray-600"></i></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
                </div>`,
            create: `
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">æ–°ã—ã„ToDo</h1>
                <form id="create-form" class="space-y-6 bg-white p-6 rounded-xl shadow-sm">
                    <input type="hidden" id="edit-todo-id" name="id">
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">ä»¶å / ãƒˆãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ å</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="title" name="title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                            <button type="button" id="ai-subtask-btn" class="bg-purple-500 text-white px-3 py-2 rounded-lg hover:bg-purple-600" title="AIã§ã‚¿ã‚¹ã‚¯ã‚’åˆ†è§£"><i class="fas fa-magic"></i></button>
                        </div>
                    </div>
                    <div><label for="content" class="block text-sm font-medium text-gray-700 mb-1">ã‚¿ã‚¹ã‚¯å†…å®¹</label><textarea id="content" name="content" rows="4" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"></textarea></div>
                    <div><label for="deadline" class="block text-sm font-medium text-gray-700 mb-1">æœŸé™</label><input type="datetime-local" id="deadline" name="deadline" required step="900" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"></div>
                    <div><label for="spreadsheet_url" class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLï¼ˆä»»æ„ï¼‰</label><input type="url" id="spreadsheet_url" name="spreadsheet_url" placeholder="https://docs.google.com/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"></div>
                    <div><label for="impact" class="block text-sm font-medium text-gray-700 mb-1">ã“ã®ã‚¿ã‚¹ã‚¯ã®å½±éŸ¿ï¼ˆå¿˜ã‚Œã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿï¼‰</label><input type="text" id="impact" name="impact" required placeholder="ä¾‹ï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¿¡ç”¨ã‚’å¤±ã†" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"></div>
                    <div>
                        <label for="repeat" class="block text-sm font-medium text-gray-700 mb-1">ç¹°ã‚Šè¿”ã—è¨­å®š</label>
                        <select id="repeat" name="repeat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-white" required>
                            <option value="none">ãªã—</option>
                            <option value="daily">æ¯æ—¥</option>
                            <option value="weekly">æ¯é€±</option>
                            <option value="monthly">æ¯æœˆ</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é‡è¦åº¦</label>
                            <select name="importance" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-white" required>
                                <option value="1">é‡è¦</option>
                                <option value="0">é‡è¦ã§ãªã„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç·Šæ€¥åº¦</label>
                            <select name="urgency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-white" required>
                                <option value="1">ç·Šæ€¥</option>
                                <option value="0">ç·Šæ€¥ã§ãªã„</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between bg-red-50 p-3 rounded-lg">
                        <div>
                            <label for="isGuardian" class="font-medium text-red-800">ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³ãƒ¢ãƒ¼ãƒ‰</label>
                            <p class="text-xs text-red-600">çµ¶å¯¾ã«å¿˜ã‚ŒãŸããªã„ã‚¿ã‚¹ã‚¯ã«è¨­å®š</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="isGuardian" name="isGuardian" value="true" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                        </label>
                    </div>
                    <button type="submit" class="w-full bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-colors">ä½œæˆã™ã‚‹</button>
                </form>`,
            matrix: `
                <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">å„ªå…ˆé †ä½ã‚’ç¢ºèª</h1>
                <div class="matrix-grid">
                    <div id="q1" class="matrix-quadrant bg-red-50" data-importance="1" data-urgency="1">
                        <h3>é‡è¦ã‹ã¤ç·Šæ€¥</h3>
                        <div class="matrix-tasks"></div>
                    </div>
                    <div id="q2" class="matrix-quadrant bg-sky-50" data-importance="1" data-urgency="0">
                        <h3>é‡è¦ã ãŒç·Šæ€¥ã§ãªã„</h3>
                        <div class="matrix-tasks"></div>
                    </div>
                    <div id="q3" class="matrix-quadrant bg-yellow-50" data-importance="0" data-urgency="1">
                        <h3>é‡è¦ã§ãªã„ãŒç·Šæ€¥</h3>
                        <div class="matrix-tasks"></div>
                    </div>
                    <div id="q4" class="matrix-quadrant bg-gray-100" data-importance="0" data-urgency="0">
                        <h3>é‡è¦ã§ã‚‚ç·Šæ€¥ã§ã‚‚ãªã„</h3>
                        <div class="matrix-tasks"></div>
                    </div>
                </div>`,
            account: `
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h1>
                <div class="bg-white p-6 rounded-xl shadow-sm space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-center">ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½</h3>
                        <p class="text-gray-600 text-center text-sm mb-4">ã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚<br>å°†æ¥çš„ã«ã¯Firebaseã¨é€£æºã—ã€è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹ã§ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
                        <input type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="w-full mb-2 px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" disabled>
                        <input type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full mb-4 px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" disabled>
                        <button class="w-full bg-gray-300 text-gray-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed">ãƒ­ã‚°ã‚¤ãƒ³ (æº–å‚™ä¸­)</button>
                    </div>
                    <hr>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-center">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                        <p class="text-sm text-gray-500 mb-4 text-center">ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                        <button id="delete-all-data" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹</button>
                    </div>
                </div>`
        };

        // --- DOMè¦ç´  ---
        const appContainer = document.getElementById('app-container');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const guardianBannerContainer = document.getElementById('guardian-banner-container');

        // --- åˆæœŸåŒ–å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            navigateTo('list');
            addEventListeners();
        });

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        function addEventListeners() {
            document.querySelector('footer').addEventListener('click', (e) => {
                const navButton = e.target.closest('.nav-button');
                if (navButton) navigateTo(navButton.dataset.view);
            });
            modalBackdrop.addEventListener('click', (e) => {
                const target = e.target;
                if (target === modalBackdrop || target.closest('.modal-close-button')) {
                    closeModal();
                }
                if (target.closest('#edit-from-detail-btn')) {
                    switchToEditView(target.closest('#edit-from-detail-btn').dataset.id);
                }
            });
            appContainer.addEventListener('click', handleAppContainerClick);
            appContainer.addEventListener('submit', handleFormSubmit);
            appContainer.addEventListener('dragstart', handleDragStart);
            appContainer.addEventListener('dragover', handleDragOver);
            appContainer.addEventListener('dragleave', handleDragLeave);
            appContainer.addEventListener('drop', handleDrop);
        }

        function handleAppContainerClick(e) {
            const target = e.target;
            if (target.closest('#todo-tabs')) handleTabClick(e);
            if (target.closest('#todo-list')) handleListClick(e);
            if (target.closest('#prev-month')) changeMonth(-1);
            if (target.closest('#next-month')) changeMonth(1);
            if (target.closest('#calendar-grid button')) handleCalendarDayClick(e);
            if (target.closest('#delete-all-data')) handleDeleteAllData();
            if (target.closest('#ai-subtask-btn')) generateSubtasks();
            if (target.closest('#morning-briefing-btn')) getMorningBriefing();
            if (target.closest('#tomorrow-briefing-btn')) getTomorrowBriefing();
            if (target.closest('.matrix-task')) showDetailModal(target.closest('.matrix-task').dataset.id);
        }

        function handleFormSubmit(e) {
            if (e.target.id === 'create-form') {
                e.preventDefault();
                const formData = new FormData(e.target);
                const todoId = formData.get('id');

                const currentTodos = JSON.parse(localStorage.getItem('holiday-todos') || '[]');

                const todoData = {
                    title: formData.get('title'),
                    content: formData.get('content'),
                    deadline: formData.get('deadline'),
                    spreadsheet_url: formData.get('spreadsheet_url'),
                    impact: formData.get('impact'),
                    repeat: formData.get('repeat'),
                    importance: formData.get('importance'),
                    urgency: formData.get('urgency'),
                    isGuardian: formData.has('isGuardian'),
                };

                if (todoId) {
                    const index = currentTodos.findIndex(t => t.id === todoId);
                    if (index !== -1) {
                        const originalTodo = currentTodos[index];
                        currentTodos[index] = { ...originalTodo, ...todoData };
                    }
                } else {
                    todoData.id = Date.now().toString();
                    todoData.completed = false;
                    currentTodos.push(todoData);
                }
                
                localStorage.setItem('holiday-todos', JSON.stringify(currentTodos));
                
                loadState();
                
                state.currentFilter = 'all';
                navigateTo('list');
            }
        }

        // --- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---
        function navigateTo(view) {
            appContainer.innerHTML = templates[view];
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
                btn.classList.toggle('text-gray-500', btn.dataset.view !== view);
            });
            if (view === 'list') {
                renderTodoList();
                renderCalendar();
                updateGuardianBanner();
            } else if (view === 'create') {
                const deadlineInput = document.getElementById('deadline');
                const now = new Date();
                now.setMinutes(Math.ceil(now.getMinutes() / 15) * 15 - now.getTimezoneOffset());
                deadlineInput.value = now.toISOString().slice(0, 16);
            } else if (view === 'matrix') {
                renderMatrixView();
            }
            setTimeout(updateBodyPadding, 0);
        }

        // --- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– ---
        function saveState() {
             localStorage.setItem('holiday-todos', JSON.stringify(state.todos));
             localStorage.setItem('holiday-consecutive-overdue', state.consecutiveOverdue);
        };
        function loadState() {
            try {
                const t = localStorage.getItem('holiday-todos');
                state.todos = t ? JSON.parse(t) : [];
                state.consecutiveOverdue = parseInt(localStorage.getItem('holiday-consecutive-overdue') || '0', 10);
            } catch (e) {
                state.todos = [];
                state.consecutiveOverdue = 0;
            }
        };

        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ (å¤‰æ›´ãªã—) ---
        function renderCalendar() { const h = document.getElementById('calendar-header'), g = document.getElementById('calendar-grid'); if (!h || !g) return; const { year: y, month: m } = { year: state.currentDate.getFullYear(), month: state.currentDate.getMonth() }; h.textContent = `${y}å¹´ ${m + 1}æœˆ`; g.innerHTML = ''; ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(d => g.innerHTML += `<div class="font-semibold text-gray-600 text-xs">${d}</div>`); const f = new Date(y, m, 1).getDay(); for (let i = 0; i < f; i++) g.appendChild(document.createElement('div')); const ds = new Date(y, m + 1, 0).getDate(); const t = new Date().setHours(0, 0, 0, 0); for (let i = 1; i <= ds; i++) { const e = document.createElement('button'); const d = new Date(y, m, i); e.className = 'relative p-2 rounded-full hover:bg-gray-100 transition-colors'; e.textContent = i; if (d.setHours(0, 0, 0, 0) === t) e.classList.add('is-today'); const ht = state.todos.some(td => { const dt = new Date(td.deadline); return dt.getFullYear() === y && dt.getMonth() === m && dt.getDate() === i; }); if (ht) e.innerHTML += '<div class="calendar-dot"></div>'; g.appendChild(e); } };
        function changeMonth(offset) { state.currentDate.setMonth(state.currentDate.getMonth() + offset); renderCalendar(); };
        function handleCalendarDayClick(e) { const b = e.target.closest('button'); if (!b || !b.textContent) return; const day = parseInt(b.textContent, 10); const d = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day); const s = new Date(d.getFullYear(), d.getMonth(), d.getDate()); const ed = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59); const tds = state.todos.filter(t => { const dt = new Date(t.deadline); return dt >= s && dt <= ed; }); showDayTodosModal(s, tds); };

        // --- ToDoãƒªã‚¹ãƒˆé–¢é€£ ---
        function renderTodoList() {
            const todoList = document.getElementById('todo-list');
            if (!todoList) return;
            const filteredTodos = getFilteredTodos();
            todoList.innerHTML = '';
            if (filteredTodos.length === 0 && state.currentFilter !== 'all') {
                todoList.innerHTML = `<li class="text-center text-gray-500 py-8"><i class="fas fa-check-circle fa-2x mb-2"></i><p>ã“ã®æœŸé–“ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ï¼</p></li>`;
                return;
            }
             if (state.todos.length === 0) {
                todoList.innerHTML = `<li class="text-center text-gray-500 py-8"><i class="fas fa-coffee fa-2x mb-2"></i><p>ã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>æœ€åˆã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ï¼</p></li>`;
                return;
            }
            const sortedTodos = [...filteredTodos].sort((a, b) => a.completed - b.completed || (b.isGuardian ? 1 : 0) - (a.isGuardian ? 1 : 0));
            sortedTodos.forEach(todo => {
                const li = document.createElement('li');
                li.className = `task-item bg-white p-4 rounded-xl shadow-sm ${todo.completed ? 'completed' : ''} ${todo.isGuardian && !todo.completed ? 'guardian-task' : ''}`;
                li.dataset.id = todo.id;
                const deadline = new Date(todo.deadline);
                const isOverdue = !todo.completed && new Date() > deadline;
                const pColors = { "11": 'border-red-500', "10": 'border-sky-500', "01": 'border-yellow-500', "00": 'border-gray-400' };
                const importanceKey = `${todo.importance || 0}${todo.urgency || 0}`;
                li.innerHTML = `<div><input type="checkbox" ${todo.completed ? 'checked' : ''} class="h-6 w-6 rounded border-gray-300 text-sky-600 focus:ring-sky-500 cursor-pointer"></div><div class="task-title-container cursor-pointer flex-grow min-w-0"><p class="task-title font-medium truncate">${todo.isGuardian ? '<i class="fas fa-shield-alt text-red-500 mr-2"></i>' : ''}${todo.title}</p><div class="flex items-center text-xs text-gray-500 mt-1"><i class="far fa-clock mr-1 ${isOverdue ? 'text-red-500' : ''}"></i><span class="${isOverdue ? 'text-red-500 font-semibold' : ''}">${formatDate(deadline)}</span></div></div><div class="flex items-center"><div class="w-1 h-6 rounded-full ${pColors[importanceKey]} border-l-4 mr-4"></div><button class="delete-button text-gray-400 hover:text-red-500 p-2 rounded-full transition-colors"><i class="fas fa-trash-alt"></i></button></div>`;
                todoList.appendChild(li);
            });
        }
        
        function handleListClick(e) { const i = e.target.closest('.task-item'); if (!i) return; const id = i.dataset.id; if (e.target.type === 'checkbox') toggleTodoCompletion(id, e.target.checked); else if (e.target.closest('.delete-button')) deleteTodo(id); else if (e.target.closest('.task-title-container')) showDetailModal(id); };
        
        function toggleTodoCompletion(id, isCompleted) {
            const todo = state.todos.find(t => t.id === id); 
            if (!todo) return;
            
            todo.completed = isCompleted;

            if (isCompleted) {
                const isOverdue = new Date() > new Date(todo.deadline);
                let messageType;
                if (isOverdue) {
                    state.consecutiveOverdue++;
                    messageType = state.consecutiveOverdue >= 3 ? 'strict' : 'gentle';
                } else {
                    state.consecutiveOverdue = 0;
                    messageType = 'reward';
                }
                showCompletionModal(messageType);
            }
            
            saveState();
            renderTodoList();
            renderCalendar();
            updateGuardianBanner();
        }

        function deleteTodo(id) {
            state.todos = state.todos.filter(t => t.id !== id);
            saveState();
            renderTodoList();
            renderCalendar();
            updateGuardianBanner();
        }

        function handleTabClick(e) { if (e.target.matches('.tab-button')) { state.currentFilter = e.target.dataset.filter; document.querySelectorAll('.tab-button').forEach(b => { b.classList.remove('text-sky-600', 'border-sky-500'); b.classList.add('text-gray-500', 'border-transparent'); }); e.target.classList.add('text-sky-600', 'border-sky-500'); renderTodoList(); } };
        
        function getFilteredTodos() {
            if (state.currentFilter === 'all') return state.todos;
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;
            if (state.currentFilter === 'today') {
                startDate = startOfToday;
                endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
            } else if (state.currentFilter === 'tomorrow') {
                startDate = new Date(startOfToday.getTime() + 24 * 3600 * 1000);
                endDate = new Date(startDate.getTime() + (24 * 3600 * 1000 - 1));
            } else if (state.currentFilter === 'week') {
                startDate = startOfToday;
                endDate = new Date(startOfToday.getTime() + (7 * 24 * 3600 * 1000 - 1));
            } else { return state.todos; }
            return state.todos.filter(t => { const d = new Date(t.deadline); return d >= startDate && d <= endDate; });
        }
        function handleDeleteAllData() { showConfirmationModal('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', 'ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚', () => { state.todos = []; state.consecutiveOverdue = 0; saveState(); closeModal(); navigateTo('list'); }); };

        // --- ã‚¢ã‚¤ã‚¼ãƒ³ãƒãƒ¯ãƒ¼ãƒãƒˆãƒªã‚¯ã‚¹æç”» ---
        function renderMatrixView() {
            const quadrants = {
                q1: document.querySelector('#q1 .matrix-tasks'),
                q2: document.querySelector('#q2 .matrix-tasks'),
                q3: document.querySelector('#q3 .matrix-tasks'),
                q4: document.querySelector('#q4 .matrix-tasks'),
            };
            Object.values(quadrants).forEach(q => q.innerHTML = '');
            const uncompletedTodos = state.todos.filter(t => !t.completed);
            const sortedTodos = uncompletedTodos.sort((a,b) => new Date(a.deadline) - new Date(b.deadline));
            sortedTodos.forEach(todo => {
                const taskEl = document.createElement('div');
                taskEl.className = 'matrix-task';
                taskEl.textContent = todo.title;
                taskEl.dataset.id = todo.id;
                taskEl.draggable = true;
                if (todo.importance === '1' && todo.urgency === '1') quadrants.q1.appendChild(taskEl);
                else if (todo.importance === '1' && todo.urgency === '0') quadrants.q2.appendChild(taskEl);
                else if (todo.importance === '0' && todo.urgency === '1') quadrants.q3.appendChild(taskEl);
                else quadrants.q4.appendChild(taskEl);
            });
        }

        // --- ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³ãƒ¢ãƒ¼ãƒ‰é–¢é€£ ---
        function updateGuardianBanner() {
            guardianBannerContainer.innerHTML = '';
            const guardianTasks = state.todos.filter(t => t.isGuardian && !t.completed);
            guardianTasks.forEach(task => {
                const banner = document.createElement('div');
                banner.className = 'guardian-banner bg-red-500 text-white p-4 text-center font-bold shadow-lg z-20 flex items-center justify-center mb-1';
                banner.innerHTML = `<i class="fas fa-exclamation-triangle mr-3 text-2xl"></i><span class="guardian-text-flash">æœ€é‡è¦ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€ãŒæœªå®Œäº†ã§ã™ï¼</span>`;
                guardianBannerContainer.appendChild(banner);
            });
            updateBodyPadding();
        }
        function updateBodyPadding() {
            const totalBannerHeight = guardianBannerContainer.offsetHeight;
            document.body.style.paddingTop = `${totalBannerHeight + 20}px`;
        }

        // --- AIæ©Ÿèƒ½é–¢é€£ ---
        async function getTomorrowBriefing() {
            const tomorrowTodos = getFilteredTodosForBriefing('tomorrow');
            if (tomorrowTodos.length === 0) {
                showModal(`<p>ãŠç–²ã‚Œæ§˜ã§ã™ï¼<br>æ˜æ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šå¤œã¯ã‚†ã£ãã‚Šä¼‘ã¿ã¾ã—ã‚‡ã†ã€‚</p><button class="modal-close-button mt-4 bg-gray-200 py-2 px-4 rounded-lg">OK</button>`);
                return;
            }
            const prompt = `ã‚ãªãŸã¯è¦ªåˆ‡ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤œã®æŒ¨æ‹¶ã‚’ã—ã€æ˜æ—¥ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å…ƒã«ã€å¿ƒã®æº–å‚™ãŒã§ãã‚‹ã‚ˆã†ãªãƒ–ãƒªãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã‚’ã—ã¦ãã ã•ã„ã€‚ç‰¹ã«é‡è¦ãªã‚¿ã‚¹ã‚¯ã‚’æŒ‡æ‘˜ã—ã€è‰¯ã„ä¸€æ—¥ã®ã‚¹ã‚¿ãƒ¼ãƒˆãŒåˆ‡ã‚Œã‚‹ã‚ˆã†ã«åŠ±ã¾ã—ã¦ãã ã•ã„ã€‚ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªå£èª¿ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚\n\næ˜æ—¥ã®ã‚¿ã‚¹ã‚¯:\n${tomorrowTodos.map(t => `- ${t.title} (é‡è¦åº¦:${t.importance === '1' ? 'é«˜' : 'ä½'}, ç·Šæ€¥åº¦:${t.urgency === '1' ? 'é«˜' : 'ä½'})`).join('\n')}`;
            showLoadingModal("AIãŒæ˜æ—¥ã®æº–å‚™ã‚’ãŠæ‰‹ä¼ã„ä¸­...");
            try {
                const resultText = await callGemini(prompt);
                showModal(`<div class="text-left whitespace-pre-wrap">${resultText}</div><button class="modal-close-button mt-4 w-full bg-indigo-500 text-white py-2 px-4 rounded-lg">ã‚ã‚ŠãŒã¨ã†ï¼</button>`);
            } catch (error) {
                showModal(`<p class="text-red-500">ãƒ–ãƒªãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p><button class="modal-close-button mt-4 bg-gray-200 py-2 px-4 rounded-lg">OK</button>`);
            }
        }
        function getFilteredTodosForBriefing(filter) {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            if (filter === 'today') {
                const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                return state.todos.filter(t => { const d = new Date(t.deadline); return d >= startOfToday && d <= endOfToday; });
            }
            if (filter === 'tomorrow') {
                const startOfTomorrow = new Date(startOfToday.getTime() + 24 * 3600 * 1000);
                const endOfTomorrow = new Date(startOfTomorrow.getTime() + (24 * 3600 * 1000 - 1));
                return state.todos.filter(t => { const d = new Date(t.deadline); return d >= startOfTomorrow && d <= endOfTomorrow; });
            }
            return [];
        }
        async function generateSubtasks() { const t = document.getElementById('title'), c = document.getElementById('content'), b = document.getElementById('ai-subtask-btn'); if (!t.value) { showModal(`<p class="text-red-500">å…ˆã«ä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p><button class="modal-close-button mt-4 bg-gray-200 py-2 px-4 rounded-lg">OK</button>`); return; } b.disabled = true; b.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; const p = `ã‚ãªãŸã¯å„ªç§€ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’ã€å…·ä½“çš„ãªè¡Œå‹•ã‚¹ãƒ†ãƒƒãƒ—ã«åˆ†è§£ã—ã¦ãã ã•ã„ã€‚ç®‡æ¡æ›¸ã(- )ã§ã€ç°¡æ½”ã«ãŠé¡˜ã„ã—ã¾ã™ã€‚\n\nã‚¿ã‚¹ã‚¯: ${t.value}`; try { const rt = await callGemini(p); c.value = rt; } catch (e) { console.error("AI Subtask Error:", e); showModal(`<p class="text-red-500">AIã«ã‚ˆã‚‹åˆ†è§£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p><button class="modal-close-button mt-4 bg-gray-200 py-2 px-4 rounded-lg">OK</button>`); } finally { b.disabled = false; b.innerHTML = `<i class="fas fa-magic"></i>`; } }
        async function getMorningBriefing() { const tt = getFilteredTodosForBriefing('today'); if (tt.length === 0) { showModal(`<p>ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼<br>ä»Šæ—¥ã‚„ã‚‹ã¹ãã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ä¸€æ—¥ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p><button class="modal-close-button mt-4 bg-gray-200 py-2 px-4 rounded-lg">OK</button>`); return; } const p = `ã‚ãªãŸã¯è¦ªåˆ‡ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æœã®æŒ¨æ‹¶ã‚’ã—ã€ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å…ƒã«ã€ã‚„ã‚‹æ°—ã‚’å¼•ãå‡ºã™ã‚ˆã†ãªãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒ–ãƒªãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã‚’ã—ã¦ãã ã•ã„ã€‚ã‚¿ã‚¹ã‚¯ã®é‡è¦åº¦ã‚‚è€ƒæ…®ã—ã€ä½•ã‹ã‚‰æ‰‹ã‚’ã¤ã‘ã‚‹ã¹ãã‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚‚ãŠé¡˜ã„ã—ã¾ã™ã€‚ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªå£èª¿ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚\n\nä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯:\n${tt.map(t => `- ${t.title} (é‡è¦åº¦:${t.importance === '1' ? 'é«˜' : 'ä½'}, ç·Šæ€¥åº¦:${t.urgency === '1' ? 'é«˜' : 'ä½'})`).join('\n')}`; showLoadingModal("AIãŒæœã®ãƒ–ãƒªãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã‚’æº–å‚™ä¸­..."); try { const rt = await callGemini(p); showModal(`<div class="text-left whitespace-pre-wrap">${rt}</div><button class="modal-close-button mt-4 w-full bg-sky-500 text-white py-2 px-4 rounded-lg">ä»Šæ—¥ã‚‚é ‘å¼µã‚‹ï¼</button>`); } catch (e) { showModal(`<p class="text-red-500">ãƒ–ãƒªãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p><button class="modal-close-button mt-4 bg-gray-200 py-2 px-4 rounded-lg">OK</button>`); } }
        async function callGemini(prompt) { const apiKey = ""; const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: prompt }] }] }; const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { throw new Error(`API request failed with status ${response.status}`); } const result = await response.json(); if (result.candidates && result.candidates.length > 0) { return result.candidates[0].content.parts[0].text; } else { throw new Error("No content received from API"); } }

        // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£ ---
        function handleDragStart(e) {
            if (e.target.classList.contains('matrix-task')) {
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.target.dataset.id);
                e.dataTransfer.effectAllowed = 'move';
            }
        }
        function handleDragOver(e) {
            e.preventDefault();
            const quadrant = e.target.closest('.matrix-quadrant');
            if (quadrant) {
                quadrant.classList.add('drag-over');
                e.dataTransfer.dropEffect = 'move';
            }
        }
        function handleDragLeave(e) {
            const quadrant = e.target.closest('.matrix-quadrant');
            if (quadrant) {
                quadrant.classList.remove('drag-over');
            }
        }
        function handleDrop(e) {
            e.preventDefault();
            const quadrant = e.target.closest('.matrix-quadrant');
            if (quadrant) {
                quadrant.classList.remove('drag-over');
                const todoId = e.dataTransfer.getData('text/plain');
                const todo = state.todos.find(t => t.id === todoId);
                if (todo) {
                    todo.importance = quadrant.dataset.importance;
                    todo.urgency = quadrant.dataset.urgency;
                    saveState();
                    renderMatrixView();
                }
            }
            document.querySelector('.dragging')?.classList.remove('dragging');
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ç·¨é›†æ©Ÿèƒ½ ---
        function showModal(c) { modalContent.innerHTML = c; modalBackdrop.classList.remove('hidden'); modalBackdrop.classList.add('flex'); modalContent.classList.add('modal-enter-active'); setTimeout(() => modalContent.classList.remove('modal-enter-active'), 200); };
        function closeModal() { modalContent.classList.add('modal-leave-active'); setTimeout(() => { modalBackdrop.classList.add('hidden'); modalBackdrop.classList.remove('flex'); modalContent.classList.remove('modal-leave-active'); }, 200); };
        function showLoadingModal(text) { showModal(`<div class="flex items-center justify-center"><i class="fas fa-spinner fa-spin mr-3"></i><p>${text}</p></div>`); }
        function showCompletionModal(t) { const m = messages[t][Math.floor(Math.random() * messages[t].length)]; const i = t === 'reward' ? 'ğŸ‰' : (t === 'gentle' ? 'ğŸ˜Š' : 'ğŸ˜¤'); showModal(`<div class="text-5xl mb-4">${i}</div><h3 class="text-xl font-bold mb-2">${t === 'reward' ? 'ã‚¿ã‚¹ã‚¯å®Œäº†ï¼' : 'ãŠç–²ã‚Œæ§˜ã§ã™ï¼'}</h3><p class="text-gray-600 mb-6">${m}</p><button class="modal-close-button w-full bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600">é–‰ã˜ã‚‹</button>`); };
        function showDetailModal(id) {
            const todo = state.todos.find(t => t.id === id); if (!todo) return;
            const imp = { "1": 'é‡è¦', "0": 'é‡è¦ã§ãªã„' }; const urg = { "1": 'ç·Šæ€¥', "0": 'ç·Šæ€¥ã§ãªã„' };
            const rep = { none: 'ãªã—', daily: 'æ¯æ—¥', weekly: 'æ¯é€±', monthly: 'æ¯æœˆ' };
            const url = todo.spreadsheet_url ? `<a href="${todo.spreadsheet_url}" target="_blank" rel="noopener noreferrer" class="text-sky-600 hover:underline break-all">${todo.spreadsheet_url}</a>` : 'ãªã—';
            showModal(`<div class="text-left"><h3 class="text-2xl font-bold mb-4">${todo.title}</h3><div class="space-y-3 text-gray-700"><div><strong class="font-semibold block text-sm">ã‚¿ã‚¹ã‚¯å†…å®¹:</strong><p class="whitespace-pre-wrap">${todo.content}</p></div><div><strong class="font-semibold">æœŸé™:</strong> ${formatDate(new Date(todo.deadline), true)}</div><div><strong class="font-semibold">å½±éŸ¿:</strong> ${todo.impact || 'æœªè¨­å®š'}</div><div><strong class="font-semibold">ç¹°ã‚Šè¿”ã—:</strong> ${rep[todo.repeat] || 'ãªã—'}</div><div><strong class="font-semibold">é‡è¦åº¦:</strong> ${imp[todo.importance] || 'æœªè¨­å®š'}</div><div><strong class="font-semibold">ç·Šæ€¥åº¦:</strong> ${urg[todo.urgency] || 'æœªè¨­å®š'}</div><div><strong class="font-semibold block">URL:</strong>${url}</div></div>
            <div class="flex gap-2 mt-6">
                <button class="modal-close-button flex-1 bg-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">é–‰ã˜ã‚‹</button>
                <button id="edit-from-detail-btn" data-id="${id}" class="flex-1 bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600">ç·¨é›†</button>
            </div>`);
        }
        function showConfirmationModal(t, x, f) { showModal(`<h3 class="text-xl font-bold mb-2">${t}</h3><p class="text-gray-600 mb-6">${x}</p><div class="flex gap-4"><button class="modal-close-button flex-1 bg-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button id="modal-confirm-btn" class="flex-1 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">å‰Šé™¤ã™ã‚‹</button></div>`); document.getElementById('modal-confirm-btn').onclick = f; };
        function showDayTodosModal(d, ts) { const ds = `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`; const l = ts.length > 0 ? `<ul class="space-y-2 text-left">${ts.map(t => `<li class="flex items-center gap-3 p-2 rounded-lg ${t.completed ? 'bg-gray-100' : ''}"><i class="fas ${t.completed ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-300'}"></i><span class="${t.completed ? 'line-through text-gray-500' : ''}">${t.title}</span></li>`).join('')}</ul>` : `<p class="text-gray-500">ã“ã®æ—¥ã®ToDoã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`; showModal(`<h3 class="text-xl font-bold mb-4">${ds}ã®ToDo</h3><div class="max-h-60 overflow-y-auto pr-2">${l}</div><button class="modal-close-button mt-6 w-full bg-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">é–‰ã˜ã‚‹</button>`); };

        function switchToEditView(id) {
            const todo = state.todos.find(t => t.id === id);
            if (!todo) return;
            closeModal();
            navigateTo('create');
            setTimeout(() => {
                document.querySelector('#app-container h1').textContent = 'ToDoã‚’ç·¨é›†';
                document.querySelector('#create-form button[type="submit"]').textContent = 'æ›´æ–°ã™ã‚‹';
                document.getElementById('edit-todo-id').value = todo.id;
                document.getElementById('title').value = todo.title;
                document.getElementById('content').value = todo.content;
                document.getElementById('deadline').value = todo.deadline;
                document.getElementById('spreadsheet_url').value = todo.spreadsheet_url || '';
                document.getElementById('impact').value = todo.impact || '';
                document.getElementById('repeat').value = todo.repeat || 'none';
                document.getElementById('importance').value = todo.importance || '1';
                document.getElementById('urgency').value = todo.urgency || '1';
                document.getElementById('isGuardian').checked = todo.isGuardian || false;
            }, 0);
        }

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function formatDate(d, w = false) { const o = { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }; if (w) o.year = 'numeric'; return new Intl.DateTimeFormat('ja-JP', o).format(d); };

    </script>
</body>
</html>
