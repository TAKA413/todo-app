<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HOLIDAY ToDo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    body {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      background-color: #f9fafb;
      color: #1f2937;
      display: flex;
      flex-direction: column;
      -webkit-tap-highlight-color: transparent;
    }
    #app-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #app-wrapper {
      flex: 1;
      overflow-y: auto;
    }
    .task-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 1rem;
    }
    .task-item.completed .task-title {
      text-decoration: line-through;
      color: #9ca3af;
    }
    .calendar-dot {
      width: 6px;
      height: 6px;
      background-color: #ef4444;
      border-radius: 50%;
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
    }
    .is-today {
      background-color: #e0f2fe;
      color: #0ea5e9;
      font-weight: bold;
    }
    .nav-button.active {
      color: #0284c7;
    }
    .modal-enter-active {
      animation: fadeIn 0.2s ease-out;
    }
    .modal-leave-active {
      animation: fadeOut 0.2s ease-in;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(0.95);
      }
    }
    #guardian-banner-container {
      padding: 10px;
      background-color: #f9fafb;
      max-width: 100%;
    }
    .guardian-banner {
      animation: pulse-bg 2s infinite;
      padding: 0.75rem;
    }
    .guardian-text-flash {
      color: #facc15;
      font-size: 1.125rem;
      animation: flash-yellow 1.5s infinite;
    }
    @keyframes flash-yellow {
      0%, 100% {
        color: #facc15;
        opacity: 1;
        transform: scale(1.05);
      }
      50% {
        color: #fde047;
        opacity: 0.8;
        transform: scale(1);
      }
    }
    .guardian-task {
      border: 2px solid #f87171;
      box-shadow: 0 0 15px rgba(248, 113, 113, 0.5);
      animation: pulse-border 2s infinite;
    }
    @keyframes pulse-border {
      0%, 100% {
        border-color: #f87171;
      }
      50% {
        border-color: #dc2626;
      }
    }
    @keyframes pulse-bg {
      0%, 100% {
        background-color: #ef4444;
      }
      50% {
        background-color: #dc2626;
      }
    }
    footer {
      position: sticky;
      bottom: 0;
      z-index: 50;
    }
  </style>
</head>
<body>
  <div id="app-body">
    <div id="guardian-banner-container"></div>
    <div id="app-wrapper">
      <div id="app-container" class="max-w-2xl mx-auto p-4"></div>
    </div>
  </div>
  <footer class="bg-white border-t border-gray-200 shadow-t-sm sticky bottom-0 z-50">
    <nav class="max-w-2xl mx-auto flex justify-around">
      <button data-view="list" class="nav-button active flex-1 py-3 text-center"><i class="fas fa-list-ul fa-lg"></i><span class="block text-xs font-medium">メイン</span></button>
      <button data-view="matrix" class="nav-button flex-1 py-3 text-center text-gray-500"><i class="fas fa-th-large fa-lg"></i><span class="block text-xs font-medium">マトリクス</span></button>
      <button data-view="create" class="nav-button flex-1 py-3 text-center text-gray-500"><i class="fas fa-plus-square fa-lg"></i><span class="block text-xs font-medium">新規作成</span></button>
      <button data-view="account" class="nav-button flex-1 py-3 text-center text-gray-500"><i class="fas fa-user-circle fa-lg"></i><span class="block text-xs font-medium">アカウント</span></button>
    </nav>
  </footer>
  <script type="module">
  const state = {
    todos: [],
    currentFilter: 'all',
    currentDate: new Date(),
    consecutiveOverdue: 0,
  };

  document.addEventListener('DOMContentLoaded', () => {
    loadState();
    navigateTo('list');
    addEventListeners();
  });

  function handleFormSubmit(e) {
    if (e.target.id === 'create-form') {
      e.preventDefault();
      const formData = new FormData(e.target);
      const todoId = formData.get('id');

      const todoData = {
        title: formData.get('title'),
        content: formData.get('content'),
        deadline: formData.get('deadline'),
        spreadsheet_url: formData.get('spreadsheet_url'),
        impact: formData.get('impact'),
        repeat: formData.get('repeat'),
        importance: formData.get('importance'),
        urgency: formData.get('urgency'),
        isGuardian: formData.has('isGuardian'),
      };

      loadState();

      if (todoId) {
        const index = state.todos.findIndex(t => t.id === todoId);
        if (index !== -1) {
          state.todos[index] = { ...state.todos[index], ...todoData };
        }
      } else {
        todoData.id = Date.now().toString();
        todoData.completed = false;
        state.todos.push(todoData);
      }

      state.currentFilter = 'all';
      saveState();
      navigateTo('list');
      setTimeout(renderTodoList, 0); // ← ここが追加された修正ポイント
    }
  }

  // ここから先の関数（renderTodoList、toggleTodoCompletion、saveState など）は前回のコードと同様です。
</script>
</body>
</html>
