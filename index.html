import csv
import os
import json
import tkinter as tk
from tkinter import filedialog, messagebox
from datetime import datetime

CONFIG_FILE = "config.json"

# 設定ファイルの読み込み
def load_config():
    if os.path.exists(CONFIG_FILE):
        with open(CONFIG_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

# 設定ファイルの保存
def save_config(config):
    with open(CONFIG_FILE, "w", encoding="utf-8") as f:
        json.dump(config, f, indent=4, ensure_ascii=False)

# CSVファイルの読み込み
def load_csv():
    file_path = filedialog.askopenfilename(
        title="CSVファイルを選択してください",
        filetypes=[("CSV Files", "*.csv")]
    )
    if not file_path:
        return

    with open(file_path, "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        rows = list(reader)

    if not rows:
        messagebox.showerror("エラー", "CSVにデータがありません。")
        return

    return rows

# 保存先のフォルダ選択
def choose_output_folder():
    default_path = config.get("last_output_dir", os.path.expanduser("~"))
    folder = filedialog.askdirectory(title="保存先フォルダを選んでください", initialdir=default_path)
    if folder:
        config["last_output_dir"] = folder
        save_config(config)
    return folder

# batファイルを出力
def create_bat_files(selected_rows, output_folder):
    for row in selected_rows:
        date = row["date"]
        time_ = row["time"]
        url = row["meeting_url"]
        title = row["title"]

        try:
            dt = datetime.strptime(date + " " + time_, "%Y/%m/%d %H:%M")
        except ValueError:
            try:
                dt = datetime.strptime(date + " " + time_, "%Y-%m-%d %H:%M")
            except:
                messagebox.showerror("エラー", f"日付フォーマットが不正です：{date} {time_}")
                return

        filename = f"{dt.strftime('%Y%m%d_%H%M')}_{title}.bat"
        filepath = os.path.join(output_folder, filename)

        with open(filepath, "w", encoding="utf-8") as f:
            f.write(f'start "" "{url}"')

# チェック付きレッスン選択画面
def show_selection_screen(rows):
    window = tk.Tk()
    window.title("Zoomレッスン選択")
    window.geometry("600x400")

    canvas = tk.Canvas(window)
    frame = tk.Frame(canvas)
    scrollbar = tk.Scrollbar(window, orient="vertical", command=canvas.yview)
    canvas.configure(yscrollcommand=scrollbar.set)

    canvas.pack(side="left", fill="both", expand=True)
    scrollbar.pack(side="right", fill="y")
    canvas.create_window((0, 0), window=frame, anchor="nw")

    check_vars = []
    for row in rows:
        var = tk.BooleanVar()
        label = f"{row['date']} {row['time']} - {row['title']}"
        cb = tk.Checkbutton(frame, text=label, variable=var)
        cb.pack(anchor="w", pady=2)
        check_vars.append((var, row))

    def on_confirm():
        selected = [r for v, r in check_vars if v.get()]
        if not selected:
            messagebox.showinfo("お知らせ", "最低1つ選んでください。")
            return
        output_folder = choose_output_folder()
        if output_folder:
            create_bat_files(selected, output_folder)
            messagebox.showinfo("完了", f"{len(selected)}件のZoomバッチファイルを作成しました。")
            window.destroy()

    btn = tk.Button(window, text="選択したレッスンを登録", command=on_confirm)
    btn.pack(pady=10)

    def resize_canvas(event):
        canvas.configure(scrollregion=canvas.bbox("all"))

    frame.bind("<Configure>", resize_canvas)
    window.mainloop()


# 起動処理
if __name__ == "__main__":
    config = load_config()
    csv_rows = load_csv()
    if csv_rows:
        show_selection_screen(csv_rows)
